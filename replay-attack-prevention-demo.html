<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSA - ì„œë²„ ì‹œê°„ ë™ê¸°í™” ê¸°ë°˜ Replay Attack ë°©ì–´</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #0066cc;
            --primary-dark: #004499;
            --primary-light: #3385d6;
            --secondary-color: #4a90e2;
            --accent-color: #ff6b6b;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --text-dark: #1a1a1a;
            --text-light: #666666;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #e0e0e0;
            --gradient-primary: linear-gradient(135deg, #0066cc 0%, #4a90e2 100%);
            --gradient-hero: linear-gradient(135deg, #0066cc 0%, #3385d6 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: var(--gradient-primary);
            padding: 40px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .flow-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .client-box, .server-box {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border-color);
        }

        .client-box {
            border-color: var(--primary-color);
        }

        .server-box {
            border-color: var(--secondary-color);
        }

        .box-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .step-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .step-item.active {
            background: rgba(0, 102, 204, 0.1);
            border-left-color: var(--success-color);
            transform: translateX(5px);
        }

        .step-item.completed {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success-color);
        }

        .step-item.error {
            background: rgba(255, 107, 107, 0.1);
            border-left-color: var(--accent-color);
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
        }

        .step-detail {
            font-size: 0.9rem;
            color: var(--text-light);
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            word-break: break-all;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gradient-primary);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .time-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .time-diff {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .time-diff.positive {
            color: var(--warning-color);
        }

        .time-diff.negative {
            color: #ffeb3b;
        }

        .control-panel {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-dark);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .status-error {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-color);
        }

        .arrow {
            text-align: center;
            font-size: 2rem;
            color: var(--primary-color);
            margin: 10px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .info-box {
            background: rgba(0, 102, 204, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info-box h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .info-box ul {
            margin-left: 20px;
            color: var(--text-light);
        }

        .info-box li {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .flow-container {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }

            .time-display {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ ì„œë²„ ì‹œê°„ ë™ê¸°í™” ê¸°ë°˜ Replay Attack ë°©ì–´</h1>
            <p>JWT í† í° + íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ì„ í†µí•œ ì¬ì „ì†¡ ê³µê²© ì°¨ë‹¨ ì‹œë®¬ë ˆì´ì…˜</p>
        </div>

        <div class="content">
            <!-- ì‹œê°„ ë™ê¸°í™” ì„¹ì…˜ -->
            <div class="section">
                <h2 class="section-title">1ë‹¨ê³„: ë¡œê·¸ì¸ ì‹œ ì„œë²„ ì‹œê°„ ë™ê¸°í™”</h2>
                
                <div class="time-display">
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ì„œë²„ ì‹œê°„</div>
                        <div class="time-value" id="serverTime">1709123456789</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">í´ë¼ì´ì–¸íŠ¸ ì‹œê°„</div>
                        <div class="time-value" id="clientTime">1709123456789</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ì‹œê°„ ì°¨ì´ (Offset)</div>
                        <div class="time-value" id="timeOffset">0 ms</div>
                    </div>
                </div>

                <div class="flow-container">
                    <div class="client-box">
                        <div class="box-header">ğŸ“± í´ë¼ì´ì–¸íŠ¸ (WebSafeBox)</div>
                        <div id="clientSteps">
                            <div class="step-item">
                                <div class="step-title">1. ë¡œê·¸ì¸ ìš”ì²­</div>
                                <div class="step-detail">POST /api/auth/login</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ì„œë²„ ì‹œê°„ ìˆ˜ì‹  ëŒ€ê¸°</div>
                                <div class="step-detail">serverTime: <span id="receivedServerTime">-</span></div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">3. ì‹œê°„ ë³´ì •ê°’ ê³„ì‚°</div>
                                <div class="step-detail">timeOffset = serverTime - clientTime</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">4. ë³´ì •ê°’ ì €ì¥</div>
                                <div class="step-detail">WSB ë©”ëª¨ë¦¬ì— timeOffset ì €ì¥</div>
                            </div>
                        </div>
                    </div>

                    <div class="server-box">
                        <div class="box-header">ğŸ–¥ï¸ ì„œë²„ (APIAuth Server)</div>
                        <div id="serverSteps">
                            <div class="step-item">
                                <div class="step-title">1. ì¸ì¦ ì²˜ë¦¬</div>
                                <div class="step-detail">ì‚¬ìš©ì ì¸ì¦ ë° JWT í† í° ìƒì„±</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ì„œë²„ ì‹œê°„ í¬í•¨ ì‘ë‹µ</div>
                                <div class="step-detail">{ token, serverTime: Date.now() }</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="btnLoginStart" onclick="startLogin()">
                        ğŸ” ë¡œê·¸ì¸ ì‹œì‘
                    </button>
                    <button class="btn btn-primary" id="btnLoginNext" onclick="nextLoginStep()" disabled style="display: none;">
                        â­ï¸ ë‹¤ìŒ ë‹¨ê³„
                    </button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">
                        ğŸ”„ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- API í˜¸ì¶œ ì„¹ì…˜ -->
            <div class="section">
                <h2 class="section-title">2ë‹¨ê³„: API í˜¸ì¶œ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ì„œëª…</h2>
                
                <div class="flow-container">
                    <div class="client-box">
                        <div class="box-header">ğŸ“± í´ë¼ì´ì–¸íŠ¸ (API ìš”ì²­)</div>
                        <div id="apiClientSteps">
                            <div class="step-item">
                                <div class="step-title">1. ì„œë²„ ì‹œê°„ ê³„ì‚°</div>
                                <div class="step-detail">serverTime = Date.now() + timeOffset</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ìš”ì²­ ë°ì´í„° êµ¬ì„±</div>
                                <div class="step-detail" id="requestData">-</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">3. ì„œëª… ìƒì„±</div>
                                <div class="step-detail">sign(JSON.stringify(data), privateKey)</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">4. API ìš”ì²­ ì „ì†¡</div>
                                <div class="step-detail">POST /api/transfer { ...data, signature }</div>
                            </div>
                        </div>
                    </div>

                    <div class="server-box">
                        <div class="box-header">ğŸ–¥ï¸ ì„œë²„ (ê²€ì¦)</div>
                        <div id="apiServerSteps">
                            <div class="step-item">
                                <div class="step-title">1. JWT í† í° ê²€ì¦</div>
                                <div class="step-detail">í† í° ìœ íš¨ì„± ë° ë§Œë£Œ ì‹œê°„ í™•ì¸</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ì„œëª… ê²€ì¦</div>
                                <div class="step-detail">Public Keyë¡œ ì„œëª…ê°’ ê²€ì¦</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">3. íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦</div>
                                <div class="step-detail">|serverTime - timestamp| â‰¤ 30ì´ˆ?</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">4. ê²€ì¦ ê²°ê³¼</div>
                                <div class="step-detail" id="verificationResult">ëŒ€ê¸° ì¤‘...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="btnApiCallStart" onclick="startApiCall()" disabled>
                        ğŸ“¤ API í˜¸ì¶œ ì‹œì‘
                    </button>
                    <button class="btn btn-primary" id="btnApiCallNext" onclick="nextApiCallStep()" disabled style="display: none;">
                        â­ï¸ ë‹¤ìŒ ë‹¨ê³„
                    </button>
                    <button class="btn btn-secondary" onclick="simulateTimeSkew()">
                        âš ï¸ ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜
                    </button>
                </div>
            </div>

            <!-- ìë™ ì¬ë™ê¸°í™” ì„¹ì…˜ -->
            <div class="section">
                <h2 class="section-title">3ë‹¨ê³„: ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œ ìë™ ì¬ë™ê¸°í™”</h2>
                
                <div class="info-box">
                    <h4>ğŸ”„ ìë™ ì¬ì‹œë„ í”„ë¡œì„¸ìŠ¤</h4>
                    <ul>
                        <li>ì„œë²„ê°€ ì‹œê°„ ì˜¤ì°¨ë¥¼ ê°ì§€í•˜ë©´ <code>419 TIME_SKEW</code> ì‘ë‹µ ë°˜í™˜</li>
                        <li>ì‘ë‹µ ë³¸ë¬¸ì— í˜„ì¬ ì„œë²„ ì‹œê°„ í¬í•¨: <code>{ code: 'TIME_SKEW', serverTime: ... }</code></li>
                        <li>í´ë¼ì´ì–¸íŠ¸ê°€ ìë™ìœ¼ë¡œ timeOffset ì¬ê³„ì‚° ë° ì €ì¥</li>
                        <li>ì›ë˜ ìš”ì²­ì„ ìë™ìœ¼ë¡œ ì¬ì „ì†¡ (ìµœëŒ€ 1íšŒ)</li>
                    </ul>
                </div>

                <div id="retrySteps" style="display: none;">
                    <div class="flow-container">
                        <div class="client-box">
                            <div class="box-header">ğŸ“± í´ë¼ì´ì–¸íŠ¸ (ìë™ ì¬ì‹œë„)</div>
                            <div id="retryClientSteps">
                                <div class="step-item">
                                    <div class="step-title">1. TIME_SKEW ì—ëŸ¬ ê°ì§€</div>
                                    <div class="step-detail">status: 419, code: 'TIME_SKEW'</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">2. ì„œë²„ ì‹œê°„ ì¬ìˆ˜ì‹ </div>
                                    <div class="step-detail">response.serverTime ì‚¬ìš©</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">3. timeOffset ì¬ê³„ì‚°</div>
                                    <div class="step-detail">ìƒˆë¡œìš´ ë³´ì •ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">4. ìë™ ì¬ì‹œë„</div>
                                    <div class="step-detail">ë™ì¼í•œ ìš”ì²­ ì¬ì „ì†¡</div>
                                </div>
                            </div>
                        </div>

                        <div class="server-box">
                            <div class="box-header">ğŸ–¥ï¸ ì„œë²„ (ì¬ê²€ì¦)</div>
                            <div id="retryServerSteps">
                                <div class="step-item">
                                    <div class="step-title">1. íƒ€ì„ìŠ¤íƒ¬í”„ ì¬ê²€ì¦</div>
                                    <div class="step-detail">ë™ê¸°í™”ëœ ì‹œê°„ìœ¼ë¡œ ì¬í™•ì¸</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">2. ê²€ì¦ í†µê³¼</div>
                                    <div class="step-detail">âœ… API ì²˜ë¦¬ ì„±ê³µ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="btnRetryStart" onclick="startRetry()" style="display: none;">
                            ğŸ”„ ì¬ë™ê¸°í™” ì‹œì‘
                        </button>
                        <button class="btn btn-primary" id="btnRetryNext" onclick="nextRetryStep()" disabled style="display: none;">
                            â­ï¸ ë‹¤ìŒ ë‹¨ê³„
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë³´ì•ˆ íŠ¹ì§• -->
            <div class="section">
                <h2 class="section-title">ğŸ”’ ë³´ì•ˆ íŠ¹ì§•</h2>
                <div class="info-box">
                    <h4>Replay Attack ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜</h4>
                    <ul>
                        <li><strong>íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦:</strong> Â±30ì´ˆ ì´ë‚´ ìš”ì²­ë§Œ í—ˆìš© (ì„¤ì • ê°€ëŠ¥)</li>
                        <li><strong>ì„œëª… ê²€ì¦:</strong> íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì„œëª…ì— í¬í•¨ë˜ì–´ ìœ„ë³€ì¡° ë¶ˆê°€</li>
                        <li><strong>ìë™ ì¬ë™ê¸°í™”:</strong> ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œ ì‚¬ìš©ì ê°œì… ì—†ì´ ìë™ ë³µêµ¬</li>
                        <li><strong>Stateless:</strong> ì„œë²„ ì €ì¥ì†Œ ë¶ˆí•„ìš”, í™•ì¥ì„± í™•ë³´</li>
                        <li><strong>í´ë¼ì´ì–¸íŠ¸ ìµœì†Œí™”:</strong> ê¸°ì¡´ ì„¸ì…˜ ë°©ì‹ê³¼ ë™ì¼í•œ ìˆ˜ì¤€ì˜ êµ¬í˜„ ë³µì¡ë„</li>
                    </ul>
                </div>
            </div>

            <!-- ë©”ì¸ í™”ë©´ ì´ë™ ë§í¬ -->
            <div class="section" style="text-align: center; padding-top: 20px; border-top: 2px solid var(--border-color);">
                <a href="index.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                    ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                </a>
            </div>
        </div>
    </div>

    <script>
        // ì‹œë®¬ë ˆì´ì…˜ ìƒíƒœ
        let isLoggedIn = false;
        let timeOffset = 0;
        let serverTime = Date.now();
        let clientTime = Date.now();

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTimeDisplay() {
            clientTime = Date.now();
            serverTime = clientTime + timeOffset;
            
            document.getElementById('serverTime').textContent = serverTime;
            document.getElementById('clientTime').textContent = clientTime;
            
            const offsetText = timeOffset >= 0 ? `+${timeOffset} ms` : `${timeOffset} ms`;
            document.getElementById('timeOffset').textContent = offsetText;
            document.getElementById('timeOffset').className = 'time-value ' + 
                (timeOffset > 0 ? 'positive' : timeOffset < 0 ? 'negative' : '');
        }

        // ë¡œê·¸ì¸ ë‹¨ê³„ ì •ì˜
        const loginSteps = [
            { client: 0, server: -1, name: '1. ë¡œê·¸ì¸ ìš”ì²­' },
            { client: -1, server: 0, name: 'ì„œë²„ ì¸ì¦ ì²˜ë¦¬' },
            { client: 1, server: 1, name: '2. ì„œë²„ ì‹œê°„ ìˆ˜ì‹ ' },
            { client: 2, server: -1, name: '3. ì‹œê°„ ë³´ì •ê°’ ê³„ì‚°' },
            { client: 3, server: -1, name: '4. ë³´ì •ê°’ ì €ì¥' }
        ];

        let loginCurrentStep = -1;

        // ë¡œê·¸ì¸ ì‹œì‘
        function startLogin() {
            resetLogin();
            loginCurrentStep = 0;
            document.getElementById('btnLoginStart').style.display = 'none';
            document.getElementById('btnLoginNext').style.display = 'inline-block';
            document.getElementById('btnLoginNext').disabled = false;
            nextLoginStep();
        }

        // ë¡œê·¸ì¸ ë‹¤ìŒ ë‹¨ê³„
        function nextLoginStep() {
            if (loginCurrentStep < 0 || loginCurrentStep >= loginSteps.length) {
                return;
            }

            const step = loginSteps[loginCurrentStep];
            const clientSteps = document.querySelectorAll('#clientSteps .step-item');
            const serverSteps = document.querySelectorAll('#serverSteps .step-item');

            // ì´ì „ ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
            if (loginCurrentStep > 0) {
                const prevStep = loginSteps[loginCurrentStep - 1];
                if (prevStep.client >= 0) clientSteps[prevStep.client].classList.remove('active');
                if (prevStep.server >= 0) serverSteps[prevStep.server].classList.remove('active');
            }

            // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
            if (step.client >= 0) {
                clientSteps[step.client].classList.add('active');
                if (step.client === 2) {
                    // ì‹œê°„ ë³´ì •ê°’ ê³„ì‚°
                    const actualServerTime = Date.now();
                    const currentClientTime = Date.now();
                    timeOffset = actualServerTime - currentClientTime;
                    updateTimeDisplay();
                }
            }
            if (step.server >= 0) {
                serverSteps[step.server].classList.add('active');
                if (step.server === 1) {
                    // ì„œë²„ ì‹œê°„ ìˆ˜ì‹ 
                    const actualServerTime = Date.now();
                    document.getElementById('receivedServerTime').textContent = actualServerTime;
                }
            }

            loginCurrentStep++;

            // ë§ˆì§€ë§‰ ë‹¨ê³„ì¸ì§€ í™•ì¸
            if (loginCurrentStep >= loginSteps.length) {
                // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
                const lastStep = loginSteps[loginSteps.length - 1];
                if (lastStep.client >= 0) {
                    clientSteps[lastStep.client].classList.remove('active');
                    clientSteps[lastStep.client].classList.add('completed');
                }
                if (lastStep.server >= 0) {
                    serverSteps[lastStep.server].classList.remove('active');
                    serverSteps[lastStep.server].classList.add('completed');
                }

                isLoggedIn = true;
                document.getElementById('btnLoginNext').disabled = true;
                document.getElementById('btnApiCallStart').disabled = false;
            }
        }

        // ë¡œê·¸ì¸ ì´ˆê¸°í™”
        function resetLogin() {
            loginCurrentStep = -1;
            document.querySelectorAll('#clientSteps .step-item, #serverSteps .step-item').forEach(item => {
                item.classList.remove('active', 'completed', 'error');
            });
        }

        // API í˜¸ì¶œ ë‹¨ê³„ ì •ì˜
        const apiCallSteps = [
            { client: 0, server: -1, name: '1. ì„œë²„ ì‹œê°„ ê³„ì‚°' },
            { client: 1, server: -1, name: '2. ìš”ì²­ ë°ì´í„° êµ¬ì„±' },
            { client: 2, server: -1, name: '3. ì„œëª… ìƒì„±' },
            { client: 3, server: -1, name: '4. API ìš”ì²­ ì „ì†¡' },
            { client: -1, server: 0, name: '1. JWT í† í° ê²€ì¦' },
            { client: -1, server: 1, name: '2. ì„œëª… ê²€ì¦' },
            { client: -1, server: 2, name: '3. íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦' },
            { client: -1, server: 3, name: '4. ê²€ì¦ ê²°ê³¼' }
        ];

        let apiCallCurrentStep = -1;
        let calculatedServerTime = 0;

        // API í˜¸ì¶œ ì‹œì‘
        function startApiCall() {
            if (!isLoggedIn) {
                alert('ë¨¼ì € ë¡œê·¸ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            resetApiCall();
            apiCallCurrentStep = 0;
            document.getElementById('btnApiCallStart').style.display = 'none';
            document.getElementById('btnApiCallNext').style.display = 'inline-block';
            document.getElementById('btnApiCallNext').disabled = false;
            nextApiCallStep();
        }

        // API í˜¸ì¶œ ë‹¤ìŒ ë‹¨ê³„
        function nextApiCallStep() {
            if (apiCallCurrentStep < 0 || apiCallCurrentStep >= apiCallSteps.length) {
                return;
            }

            const step = apiCallSteps[apiCallCurrentStep];
            const clientSteps = document.querySelectorAll('#apiClientSteps .step-item');
            const serverSteps = document.querySelectorAll('#apiServerSteps .step-item');

            // ì´ì „ ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
            if (apiCallCurrentStep > 0) {
                const prevStep = apiCallSteps[apiCallCurrentStep - 1];
                if (prevStep.client >= 0) clientSteps[prevStep.client].classList.remove('active');
                if (prevStep.server >= 0) serverSteps[prevStep.server].classList.remove('active');
            }

            // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
            if (step.client >= 0) {
                clientSteps[step.client].classList.add('active');
                if (step.client === 0) {
                    // ì„œë²„ ì‹œê°„ ê³„ì‚°
                    calculatedServerTime = Date.now() + timeOffset;
                } else if (step.client === 1) {
                    // ìš”ì²­ ë°ì´í„° êµ¬ì„±
                    const requestData = {
                        accountId: '12345',
                        amount: 10000,
                        timestamp: calculatedServerTime
                    };
                    document.getElementById('requestData').textContent = JSON.stringify(requestData, null, 2);
                }
            }
            if (step.server >= 0) {
                serverSteps[step.server].classList.add('active');
                if (step.server === 2) {
                    // íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦
                    const currentServerTime = Date.now();
                    const timeDiff = Math.abs(currentServerTime - calculatedServerTime);
                    const isValid = timeDiff <= 30000; // 30ì´ˆ
                } else if (step.server === 3) {
                    // ê²€ì¦ ê²°ê³¼
                    const currentServerTime = Date.now();
                    const timeDiff = Math.abs(currentServerTime - calculatedServerTime);
                    const isValid = timeDiff <= 30000;
                    if (isValid) {
                        document.getElementById('verificationResult').innerHTML = 
                            `<span class="status-badge status-success">âœ… ê²€ì¦ í†µê³¼</span><br>` +
                            `ì‹œê°„ ì°¨ì´: ${timeDiff}ms (í—ˆìš© ë²”ìœ„: 30ì´ˆ)`;
                    } else {
                        document.getElementById('verificationResult').innerHTML = 
                            `<span class="status-badge status-error">âŒ ê²€ì¦ ì‹¤íŒ¨</span><br>` +
                            `ì‹œê°„ ì°¨ì´: ${timeDiff}ms (í—ˆìš© ë²”ìœ„ ì´ˆê³¼)`;
                    }
                }
            }

            apiCallCurrentStep++;

            // ë§ˆì§€ë§‰ ë‹¨ê³„ì¸ì§€ í™•ì¸
            if (apiCallCurrentStep >= apiCallSteps.length) {
                // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
                const lastStep = apiCallSteps[apiCallSteps.length - 1];
                if (lastStep.client >= 0) {
                    clientSteps[lastStep.client].classList.remove('active');
                    clientSteps[lastStep.client].classList.add('completed');
                }
                if (lastStep.server >= 0) {
                    serverSteps[lastStep.server].classList.remove('active');
                    serverSteps[lastStep.server].classList.add('completed');
                }

                document.getElementById('btnApiCallNext').disabled = true;
            }
        }

        // API í˜¸ì¶œ ì´ˆê¸°í™”
        function resetApiCall() {
            apiCallCurrentStep = -1;
            document.querySelectorAll('#apiClientSteps .step-item, #apiServerSteps .step-item').forEach(item => {
                item.classList.remove('active', 'completed', 'error');
            });
            document.getElementById('requestData').textContent = '-';
            document.getElementById('verificationResult').textContent = 'ëŒ€ê¸° ì¤‘...';
        }

        // ì¬ë™ê¸°í™” ë‹¨ê³„ ì •ì˜
        const retrySteps = [
            { client: 0, server: -1, name: '1. TIME_SKEW ì—ëŸ¬ ê°ì§€' },
            { client: 1, server: -1, name: '2. ì„œë²„ ì‹œê°„ ì¬ìˆ˜ì‹ ' },
            { client: 2, server: -1, name: '3. timeOffset ì¬ê³„ì‚°' },
            { client: 3, server: -1, name: '4. ìë™ ì¬ì‹œë„' },
            { client: -1, server: 0, name: '1. íƒ€ì„ìŠ¤íƒ¬í”„ ì¬ê²€ì¦' },
            { client: -1, server: 1, name: '2. ê²€ì¦ í†µê³¼' }
        ];

        let retryCurrentStep = -1;

        // ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜
        function simulateTimeSkew() {
            if (!isLoggedIn) {
                alert('ë¨¼ì € ë¡œê·¸ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì‹œê°„ ì˜¤ì°¨ ì¸ìœ„ì ìœ¼ë¡œ ìƒì„±
            timeOffset = 60000; // 1ë¶„ ì˜¤ì°¨
            updateTimeDisplay();

            // API í˜¸ì¶œì„ ë¨¼ì € ì™„ë£Œí•´ì•¼ í•¨
            if (apiCallCurrentStep < apiCallSteps.length) {
                alert('ë¨¼ì € API í˜¸ì¶œì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì¬ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤ í‘œì‹œ
            document.getElementById('retrySteps').style.display = 'block';
            resetRetry();
            retryCurrentStep = 0;
            document.getElementById('btnRetryStart').style.display = 'inline-block';
            document.getElementById('btnRetryNext').style.display = 'inline-block';
            document.getElementById('btnRetryNext').disabled = false;
            startRetry();
        }

        // ì¬ë™ê¸°í™” ì‹œì‘
        function startRetry() {
            if (retryCurrentStep < 0) {
                retryCurrentStep = 0;
            }
            document.getElementById('btnRetryStart').style.display = 'none';
            nextRetryStep();
        }

        // ì¬ë™ê¸°í™” ë‹¤ìŒ ë‹¨ê³„
        function nextRetryStep() {
            if (retryCurrentStep < 0 || retryCurrentStep >= retrySteps.length) {
                return;
            }

            const step = retrySteps[retryCurrentStep];
            const retryClientSteps = document.querySelectorAll('#retryClientSteps .step-item');
            const retryServerSteps = document.querySelectorAll('#retryServerSteps .step-item');

            // ì´ì „ ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
            if (retryCurrentStep > 0) {
                const prevStep = retrySteps[retryCurrentStep - 1];
                if (prevStep.client >= 0) retryClientSteps[prevStep.client].classList.remove('active');
                if (prevStep.server >= 0) retryServerSteps[prevStep.server].classList.remove('active');
            }

            // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
            if (step.client >= 0) {
                retryClientSteps[step.client].classList.add('active');
                if (step.client === 1) {
                    // ì„œë²„ ì‹œê°„ ì¬ìˆ˜ì‹ 
                    const newServerTime = Date.now();
                } else if (step.client === 2) {
                    // timeOffset ì¬ê³„ì‚°
                    const newServerTime = Date.now();
                    timeOffset = newServerTime - Date.now();
                    updateTimeDisplay();
                }
            }
            if (step.server >= 0) {
                retryServerSteps[step.server].classList.add('active');
            }

            retryCurrentStep++;

            // ë§ˆì§€ë§‰ ë‹¨ê³„ì¸ì§€ í™•ì¸
            if (retryCurrentStep >= retrySteps.length) {
                // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
                const lastStep = retrySteps[retrySteps.length - 1];
                if (lastStep.client >= 0) {
                    retryClientSteps[lastStep.client].classList.remove('active');
                    retryClientSteps[lastStep.client].classList.add('completed');
                }
                if (lastStep.server >= 0) {
                    retryServerSteps[lastStep.server].classList.remove('active');
                    retryServerSteps[lastStep.server].classList.add('completed');
                }

                document.getElementById('btnRetryNext').disabled = true;
            }
        }

        // ì¬ë™ê¸°í™” ì´ˆê¸°í™”
        function resetRetry() {
            retryCurrentStep = -1;
            document.querySelectorAll('#retryClientSteps .step-item, #retryServerSteps .step-item').forEach(item => {
                item.classList.remove('active', 'completed', 'error');
            });
        }

        // ì´ˆê¸°í™”
        function resetSimulation() {
            isLoggedIn = false;
            timeOffset = 0;
            loginCurrentStep = -1;
            apiCallCurrentStep = -1;
            retryCurrentStep = -1;
            updateTimeDisplay();

            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active', 'completed', 'error');
            });

            // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ˆê¸°í™”
            document.getElementById('btnLoginStart').style.display = 'inline-block';
            document.getElementById('btnLoginNext').style.display = 'none';
            document.getElementById('btnLoginNext').disabled = true;

            // API í˜¸ì¶œ ë²„íŠ¼ ì´ˆê¸°í™”
            document.getElementById('btnApiCallStart').disabled = true;
            document.getElementById('btnApiCallStart').style.display = 'inline-block';
            document.getElementById('btnApiCallNext').style.display = 'none';
            document.getElementById('btnApiCallNext').disabled = true;

            // ì¬ë™ê¸°í™” ë²„íŠ¼ ì´ˆê¸°í™”
            document.getElementById('btnRetryStart').style.display = 'none';
            document.getElementById('btnRetryNext').style.display = 'none';
            document.getElementById('btnRetryNext').disabled = true;

            document.getElementById('receivedServerTime').textContent = '-';
            document.getElementById('requestData').textContent = '-';
            document.getElementById('verificationResult').textContent = 'ëŒ€ê¸° ì¤‘...';
            document.getElementById('retrySteps').style.display = 'none';
        }

        // ìœ í‹¸ë¦¬í‹°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
        setInterval(updateTimeDisplay, 1000);
        updateTimeDisplay();
    </script>
</body>
</html>



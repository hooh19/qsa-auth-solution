<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSA - ì„œë²„ ì‹œê°„ ë™ê¸°í™” ê¸°ë°˜ Replay Attack ë°©ì–´</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #0066cc;
            --primary-dark: #004499;
            --primary-light: #3385d6;
            --secondary-color: #4a90e2;
            --accent-color: #ff6b6b;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --text-dark: #1a1a1a;
            --text-light: #666666;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #e0e0e0;
            --gradient-primary: linear-gradient(135deg, #0066cc 0%, #4a90e2 100%);
            --gradient-hero: linear-gradient(135deg, #0066cc 0%, #3385d6 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: var(--gradient-primary);
            padding: 40px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .flow-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .client-box, .server-box {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border-color);
        }

        .client-box {
            border-color: var(--primary-color);
        }

        .server-box {
            border-color: var(--secondary-color);
        }

        .box-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .step-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .step-item.active {
            background: rgba(0, 102, 204, 0.1);
            border-left-color: var(--success-color);
            transform: translateX(5px);
        }

        .step-item.completed {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success-color);
        }

        .step-item.error {
            background: rgba(255, 107, 107, 0.1);
            border-left-color: var(--accent-color);
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
        }

        .step-detail {
            font-size: 0.9rem;
            color: var(--text-light);
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            word-break: break-all;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gradient-primary);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .time-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .time-diff {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .time-diff.positive {
            color: var(--warning-color);
        }

        .time-diff.negative {
            color: #ffeb3b;
        }

        .control-panel {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-dark);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .status-error {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-color);
        }

        .arrow {
            text-align: center;
            font-size: 2rem;
            color: var(--primary-color);
            margin: 10px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .info-box {
            background: rgba(0, 102, 204, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info-box h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .info-box ul {
            margin-left: 20px;
            color: var(--text-light);
        }

        .info-box li {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .flow-container {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }

            .time-display {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ ì„œë²„ ì‹œê°„ ë™ê¸°í™” ê¸°ë°˜ Replay Attack ë°©ì–´</h1>
            <p>JWT í† í° + íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ì„ í†µí•œ ì¬ì „ì†¡ ê³µê²© ì°¨ë‹¨ ì‹œë®¬ë ˆì´ì…˜</p>
        </div>

        <div class="content">
            <!-- ì‹œê°„ ë™ê¸°í™” ì„¹ì…˜ -->
            <div class="section">
                <h2 class="section-title">1ë‹¨ê³„: ë¡œê·¸ì¸ ì‹œ ì„œë²„ ì‹œê°„ ë™ê¸°í™”</h2>
                
                <div class="time-display">
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ì„œë²„ ì‹œê°„</div>
                        <div class="time-value" id="serverTime">1709123456789</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">í´ë¼ì´ì–¸íŠ¸ ì‹œê°„</div>
                        <div class="time-value" id="clientTime">1709123456789</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ì‹œê°„ ì°¨ì´ (Offset)</div>
                        <div class="time-value" id="timeOffset">0 ms</div>
                    </div>
                </div>

                <div class="flow-container">
                    <div class="client-box">
                        <div class="box-header">ğŸ“± í´ë¼ì´ì–¸íŠ¸ (WebSafeBox)</div>
                        <div id="clientSteps">
                            <div class="step-item">
                                <div class="step-title">1. ë¡œê·¸ì¸ ìš”ì²­</div>
                                <div class="step-detail">POST /api/auth/login</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ì„œë²„ ì‹œê°„ ìˆ˜ì‹  ëŒ€ê¸°</div>
                                <div class="step-detail">serverTime: <span id="receivedServerTime">-</span></div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">3. ì‹œê°„ ë³´ì •ê°’ ê³„ì‚°</div>
                                <div class="step-detail">timeOffset = serverTime - clientTime</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">4. ë³´ì •ê°’ ì €ì¥</div>
                                <div class="step-detail">WSB ë©”ëª¨ë¦¬ì— timeOffset ì €ì¥</div>
                            </div>
                        </div>
                    </div>

                    <div class="server-box">
                        <div class="box-header">ğŸ–¥ï¸ ì„œë²„ (APIAuth Server)</div>
                        <div id="serverSteps">
                            <div class="step-item">
                                <div class="step-title">1. ì¸ì¦ ì²˜ë¦¬</div>
                                <div class="step-detail">ì‚¬ìš©ì ì¸ì¦ ë° JWT í† í° ìƒì„±</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ì„œë²„ ì‹œê°„ í¬í•¨ ì‘ë‹µ</div>
                                <div class="step-detail">{ token, serverTime: Date.now() }</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="btnLogin" onclick="simulateLogin()">
                        ğŸ” ë¡œê·¸ì¸ ì‹œë®¬ë ˆì´ì…˜
                    </button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">
                        ğŸ”„ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- API í˜¸ì¶œ ì„¹ì…˜ -->
            <div class="section">
                <h2 class="section-title">2ë‹¨ê³„: API í˜¸ì¶œ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ì„œëª…</h2>
                
                <div class="flow-container">
                    <div class="client-box">
                        <div class="box-header">ğŸ“± í´ë¼ì´ì–¸íŠ¸ (API ìš”ì²­)</div>
                        <div id="apiClientSteps">
                            <div class="step-item">
                                <div class="step-title">1. ì„œë²„ ì‹œê°„ ê³„ì‚°</div>
                                <div class="step-detail">serverTime = Date.now() + timeOffset</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ìš”ì²­ ë°ì´í„° êµ¬ì„±</div>
                                <div class="step-detail" id="requestData">-</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">3. ì„œëª… ìƒì„±</div>
                                <div class="step-detail">sign(JSON.stringify(data), privateKey)</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">4. API ìš”ì²­ ì „ì†¡</div>
                                <div class="step-detail">POST /api/transfer { ...data, signature }</div>
                            </div>
                        </div>
                    </div>

                    <div class="server-box">
                        <div class="box-header">ğŸ–¥ï¸ ì„œë²„ (ê²€ì¦)</div>
                        <div id="apiServerSteps">
                            <div class="step-item">
                                <div class="step-title">1. JWT í† í° ê²€ì¦</div>
                                <div class="step-detail">í† í° ìœ íš¨ì„± ë° ë§Œë£Œ ì‹œê°„ í™•ì¸</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">2. ì„œëª… ê²€ì¦</div>
                                <div class="step-detail">Public Keyë¡œ ì„œëª…ê°’ ê²€ì¦</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">3. íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦</div>
                                <div class="step-detail">|serverTime - timestamp| â‰¤ 30ì´ˆ?</div>
                            </div>
                            <div class="step-item">
                                <div class="step-title">4. ê²€ì¦ ê²°ê³¼</div>
                                <div class="step-detail" id="verificationResult">ëŒ€ê¸° ì¤‘...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="btnApiCall" onclick="simulateApiCall()" disabled>
                        ğŸ“¤ API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
                    </button>
                    <button class="btn btn-secondary" onclick="simulateTimeSkew()">
                        âš ï¸ ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜
                    </button>
                </div>
            </div>

            <!-- ìë™ ì¬ë™ê¸°í™” ì„¹ì…˜ -->
            <div class="section">
                <h2 class="section-title">3ë‹¨ê³„: ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œ ìë™ ì¬ë™ê¸°í™”</h2>
                
                <div class="info-box">
                    <h4>ğŸ”„ ìë™ ì¬ì‹œë„ í”„ë¡œì„¸ìŠ¤</h4>
                    <ul>
                        <li>ì„œë²„ê°€ ì‹œê°„ ì˜¤ì°¨ë¥¼ ê°ì§€í•˜ë©´ <code>419 TIME_SKEW</code> ì‘ë‹µ ë°˜í™˜</li>
                        <li>ì‘ë‹µ ë³¸ë¬¸ì— í˜„ì¬ ì„œë²„ ì‹œê°„ í¬í•¨: <code>{ code: 'TIME_SKEW', serverTime: ... }</code></li>
                        <li>í´ë¼ì´ì–¸íŠ¸ê°€ ìë™ìœ¼ë¡œ timeOffset ì¬ê³„ì‚° ë° ì €ì¥</li>
                        <li>ì›ë˜ ìš”ì²­ì„ ìë™ìœ¼ë¡œ ì¬ì „ì†¡ (ìµœëŒ€ 1íšŒ)</li>
                    </ul>
                </div>

                <div id="retrySteps" style="display: none;">
                    <div class="flow-container">
                        <div class="client-box">
                            <div class="box-header">ğŸ“± í´ë¼ì´ì–¸íŠ¸ (ìë™ ì¬ì‹œë„)</div>
                            <div id="retryClientSteps">
                                <div class="step-item">
                                    <div class="step-title">1. TIME_SKEW ì—ëŸ¬ ê°ì§€</div>
                                    <div class="step-detail">status: 419, code: 'TIME_SKEW'</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">2. ì„œë²„ ì‹œê°„ ì¬ìˆ˜ì‹ </div>
                                    <div class="step-detail">response.serverTime ì‚¬ìš©</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">3. timeOffset ì¬ê³„ì‚°</div>
                                    <div class="step-detail">ìƒˆë¡œìš´ ë³´ì •ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">4. ìë™ ì¬ì‹œë„</div>
                                    <div class="step-detail">ë™ì¼í•œ ìš”ì²­ ì¬ì „ì†¡</div>
                                </div>
                            </div>
                        </div>

                        <div class="server-box">
                            <div class="box-header">ğŸ–¥ï¸ ì„œë²„ (ì¬ê²€ì¦)</div>
                            <div id="retryServerSteps">
                                <div class="step-item">
                                    <div class="step-title">1. íƒ€ì„ìŠ¤íƒ¬í”„ ì¬ê²€ì¦</div>
                                    <div class="step-detail">ë™ê¸°í™”ëœ ì‹œê°„ìœ¼ë¡œ ì¬í™•ì¸</div>
                                </div>
                                <div class="step-item">
                                    <div class="step-title">2. ê²€ì¦ í†µê³¼</div>
                                    <div class="step-detail">âœ… API ì²˜ë¦¬ ì„±ê³µ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë³´ì•ˆ íŠ¹ì§• -->
            <div class="section">
                <h2 class="section-title">ğŸ”’ ë³´ì•ˆ íŠ¹ì§•</h2>
                <div class="info-box">
                    <h4>Replay Attack ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜</h4>
                    <ul>
                        <li><strong>íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦:</strong> Â±30ì´ˆ ì´ë‚´ ìš”ì²­ë§Œ í—ˆìš© (ì„¤ì • ê°€ëŠ¥)</li>
                        <li><strong>ì„œëª… ê²€ì¦:</strong> íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì„œëª…ì— í¬í•¨ë˜ì–´ ìœ„ë³€ì¡° ë¶ˆê°€</li>
                        <li><strong>ìë™ ì¬ë™ê¸°í™”:</strong> ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œ ì‚¬ìš©ì ê°œì… ì—†ì´ ìë™ ë³µêµ¬</li>
                        <li><strong>Stateless:</strong> ì„œë²„ ì €ì¥ì†Œ ë¶ˆí•„ìš”, í™•ì¥ì„± í™•ë³´</li>
                        <li><strong>í´ë¼ì´ì–¸íŠ¸ ìµœì†Œí™”:</strong> ê¸°ì¡´ ì„¸ì…˜ ë°©ì‹ê³¼ ë™ì¼í•œ ìˆ˜ì¤€ì˜ êµ¬í˜„ ë³µì¡ë„</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì‹œë®¬ë ˆì´ì…˜ ìƒíƒœ
        let isLoggedIn = false;
        let timeOffset = 0;
        let serverTime = Date.now();
        let clientTime = Date.now();

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTimeDisplay() {
            clientTime = Date.now();
            serverTime = clientTime + timeOffset;
            
            document.getElementById('serverTime').textContent = serverTime;
            document.getElementById('clientTime').textContent = clientTime;
            
            const offsetText = timeOffset >= 0 ? `+${timeOffset} ms` : `${timeOffset} ms`;
            document.getElementById('timeOffset').textContent = offsetText;
            document.getElementById('timeOffset').className = 'time-value ' + 
                (timeOffset > 0 ? 'positive' : timeOffset < 0 ? 'negative' : '');
        }

        // ë¡œê·¸ì¸ ì‹œë®¬ë ˆì´ì…˜
        async function simulateLogin() {
            const btn = document.getElementById('btnLogin');
            btn.disabled = true;

            // í´ë¼ì´ì–¸íŠ¸ ë‹¨ê³„ í™œì„±í™”
            const clientSteps = document.querySelectorAll('#clientSteps .step-item');
            const serverSteps = document.querySelectorAll('#serverSteps .step-item');

            // 1. ë¡œê·¸ì¸ ìš”ì²­
            clientSteps[0].classList.add('active');
            await sleep(800);
            clientSteps[0].classList.remove('active');
            clientSteps[0].classList.add('completed');

            // ì„œë²„ ì¸ì¦ ì²˜ë¦¬
            serverSteps[0].classList.add('active');
            await sleep(600);
            serverSteps[0].classList.remove('active');
            serverSteps[0].classList.add('completed');

            // 2. ì„œë²„ ì‹œê°„ ìˆ˜ì‹ 
            serverSteps[1].classList.add('active');
            const actualServerTime = Date.now();
            document.getElementById('receivedServerTime').textContent = actualServerTime;
            await sleep(500);
            serverSteps[1].classList.remove('active');
            serverSteps[1].classList.add('completed');

            clientSteps[1].classList.add('active');
            await sleep(500);
            clientSteps[1].classList.remove('active');
            clientSteps[1].classList.add('completed');

            // 3. ì‹œê°„ ë³´ì •ê°’ ê³„ì‚°
            clientSteps[2].classList.add('active');
            const currentClientTime = Date.now();
            timeOffset = actualServerTime - currentClientTime;
            updateTimeDisplay();
            await sleep(600);
            clientSteps[2].classList.remove('active');
            clientSteps[2].classList.add('completed');

            // 4. ë³´ì •ê°’ ì €ì¥
            clientSteps[3].classList.add('active');
            await sleep(400);
            clientSteps[3].classList.remove('active');
            clientSteps[3].classList.add('completed');

            isLoggedIn = true;
            document.getElementById('btnApiCall').disabled = false;
            btn.textContent = 'âœ… ë¡œê·¸ì¸ ì™„ë£Œ';
        }

        // API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
        async function simulateApiCall() {
            const btn = document.getElementById('btnApiCall');
            btn.disabled = true;

            const clientSteps = document.querySelectorAll('#apiClientSteps .step-item');
            const serverSteps = document.querySelectorAll('#apiServerSteps .step-item');

            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            clientSteps.forEach(step => {
                step.classList.remove('active', 'completed', 'error');
            });
            serverSteps.forEach(step => {
                step.classList.remove('active', 'completed', 'error');
            });

            // í´ë¼ì´ì–¸íŠ¸: ì„œë²„ ì‹œê°„ ê³„ì‚°
            clientSteps[0].classList.add('active');
            const calculatedServerTime = Date.now() + timeOffset;
            await sleep(500);
            clientSteps[0].classList.remove('active');
            clientSteps[0].classList.add('completed');

            // í´ë¼ì´ì–¸íŠ¸: ìš”ì²­ ë°ì´í„° êµ¬ì„±
            clientSteps[1].classList.add('active');
            const requestData = {
                accountId: '12345',
                amount: 10000,
                timestamp: calculatedServerTime
            };
            document.getElementById('requestData').textContent = JSON.stringify(requestData, null, 2);
            await sleep(600);
            clientSteps[1].classList.remove('active');
            clientSteps[1].classList.add('completed');

            // í´ë¼ì´ì–¸íŠ¸: ì„œëª… ìƒì„±
            clientSteps[2].classList.add('active');
            await sleep(700);
            clientSteps[2].classList.remove('active');
            clientSteps[2].classList.add('completed');

            // í´ë¼ì´ì–¸íŠ¸: API ìš”ì²­ ì „ì†¡
            clientSteps[3].classList.add('active');
            await sleep(500);
            clientSteps[3].classList.remove('active');
            clientSteps[3].classList.add('completed');

            // ì„œë²„: JWT í† í° ê²€ì¦
            serverSteps[0].classList.add('active');
            await sleep(600);
            serverSteps[0].classList.remove('active');
            serverSteps[0].classList.add('completed');

            // ì„œë²„: ì„œëª… ê²€ì¦
            serverSteps[1].classList.add('active');
            await sleep(700);
            serverSteps[1].classList.remove('active');
            serverSteps[1].classList.add('completed');

            // ì„œë²„: íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦
            serverSteps[2].classList.add('active');
            const currentServerTime = Date.now();
            const timeDiff = Math.abs(currentServerTime - calculatedServerTime);
            const isValid = timeDiff <= 30000; // 30ì´ˆ
            await sleep(600);
            serverSteps[2].classList.remove('active');
            serverSteps[2].classList.add('completed');

            // ì„œë²„: ê²€ì¦ ê²°ê³¼
            serverSteps[3].classList.add('active');
            if (isValid) {
                document.getElementById('verificationResult').innerHTML = 
                    `<span class="status-badge status-success">âœ… ê²€ì¦ í†µê³¼</span><br>` +
                    `ì‹œê°„ ì°¨ì´: ${timeDiff}ms (í—ˆìš© ë²”ìœ„: 30ì´ˆ)`;
            } else {
                document.getElementById('verificationResult').innerHTML = 
                    `<span class="status-badge status-error">âŒ ê²€ì¦ ì‹¤íŒ¨</span><br>` +
                    `ì‹œê°„ ì°¨ì´: ${timeDiff}ms (í—ˆìš© ë²”ìœ„ ì´ˆê³¼)`;
            }
            await sleep(500);
            serverSteps[3].classList.remove('active');
            serverSteps[3].classList.add('completed');

            btn.disabled = false;
        }

        // ì‹œê°„ ì˜¤ì°¨ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜
        async function simulateTimeSkew() {
            // ì‹œê°„ ì˜¤ì°¨ ì¸ìœ„ì ìœ¼ë¡œ ìƒì„±
            const oldOffset = timeOffset;
            timeOffset = 60000; // 1ë¶„ ì˜¤ì°¨
            updateTimeDisplay();

            // API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
            await simulateApiCall();

            // ì¬ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤ í‘œì‹œ
            document.getElementById('retrySteps').style.display = 'block';
            const retryClientSteps = document.querySelectorAll('#retryClientSteps .step-item');
            const retryServerSteps = document.querySelectorAll('#retryServerSteps .step-item');

            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            retryClientSteps.forEach(step => {
                step.classList.remove('active', 'completed', 'error');
            });
            retryServerSteps.forEach(step => {
                step.classList.remove('active', 'completed', 'error');
            });

            // TIME_SKEW ì—ëŸ¬ ê°ì§€
            retryClientSteps[0].classList.add('active');
            await sleep(500);
            retryClientSteps[0].classList.remove('active');
            retryClientSteps[0].classList.add('completed');

            // ì„œë²„ ì‹œê°„ ì¬ìˆ˜ì‹ 
            retryClientSteps[1].classList.add('active');
            const newServerTime = Date.now();
            await sleep(500);
            retryClientSteps[1].classList.remove('active');
            retryClientSteps[1].classList.add('completed');

            // timeOffset ì¬ê³„ì‚°
            retryClientSteps[2].classList.add('active');
            timeOffset = newServerTime - Date.now();
            updateTimeDisplay();
            await sleep(600);
            retryClientSteps[2].classList.remove('active');
            retryClientSteps[2].classList.add('completed');

            // ìë™ ì¬ì‹œë„
            retryClientSteps[3].classList.add('active');
            await sleep(500);
            retryClientSteps[3].classList.remove('active');
            retryClientSteps[3].classList.add('completed');

            // ì„œë²„ ì¬ê²€ì¦
            retryServerSteps[0].classList.add('active');
            await sleep(600);
            retryServerSteps[0].classList.remove('active');
            retryServerSteps[0].classList.add('completed');

            retryServerSteps[1].classList.add('active');
            await sleep(500);
            retryServerSteps[1].classList.remove('active');
            retryServerSteps[1].classList.add('completed');
        }

        // ì´ˆê¸°í™”
        function resetSimulation() {
            isLoggedIn = false;
            timeOffset = 0;
            updateTimeDisplay();

            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active', 'completed', 'error');
            });

            document.getElementById('btnLogin').disabled = false;
            document.getElementById('btnLogin').textContent = 'ğŸ” ë¡œê·¸ì¸ ì‹œë®¬ë ˆì´ì…˜';
            document.getElementById('btnApiCall').disabled = true;
            document.getElementById('receivedServerTime').textContent = '-';
            document.getElementById('requestData').textContent = '-';
            document.getElementById('verificationResult').textContent = 'ëŒ€ê¸° ì¤‘...';
            document.getElementById('retrySteps').style.display = 'none';
        }

        // ìœ í‹¸ë¦¬í‹°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
        setInterval(updateTimeDisplay, 1000);
        updateTimeDisplay();
    </script>
</body>
</html>


